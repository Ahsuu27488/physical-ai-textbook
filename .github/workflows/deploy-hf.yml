name: Deploy to Hugging Face Spaces

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-hf.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Push to Hugging Face Spaces
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME || 'Ahsuu27488' }}
          HF_SPACE_ID: Ahsuu27488/physical-ai-textbook-backend
        run: |
          # Configure git
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

          # Clone HF Space (shallow clone for speed)
          git clone --depth 1 https://huggingface.co/spaces/$HF_SPACE_ID temp_hf_space

          # Copy only backend folder contents
          rsync -av --delete \
            --exclude='.git*' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.venv' \
            --exclude='node_modules' \
            --exclude='test.db' \
            --exclude='*.bat' \
            --exclude='*.sh' \
            backend/ temp_hf_space/

          # Copy README_HF.md as README.md for HF Space
          cp backend/README_HF.md temp_hf_space/README.md

          # Push to HF Space
          cd temp_hf_space
          git add .
          git diff --staged --quiet || git commit -m "Deploy from GitHub: ${{ github.sha }}"
          # Use USERNAME:TOKEN format for authentication
          git push https://$HF_USERNAME:$HF_TOKEN@huggingface.co/spaces/$HF_SPACE_ID main
